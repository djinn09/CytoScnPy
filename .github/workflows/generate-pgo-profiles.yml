name: Generate PGO Profiles

# Manual trigger only - run when you need to regenerate profiles
on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to generate profile for"
        required: true
        type: choice
        options:
          - windows
          - linux
          - macos
          - all

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # =============================================================================
  # Generate PGO Profile for Windows
  # =============================================================================
  generate-windows:
    name: Generate PGO Profile (Windows)
    runs-on: windows-latest
    if: ${{ inputs.platform == 'windows' || inputs.platform == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: pgo-windows

      - name: Generate PGO profile
        shell: pwsh
        run: .\scripts\build_pgo.ps1

      - name: Upload PGO profile
        uses: actions/upload-artifact@v4
        with:
          name: pgo-profile-windows
          path: target/pgo-data/merged.profdata
          retention-days: 30

  # =============================================================================
  # Generate PGO Profile for Linux
  # =============================================================================
  generate-linux:
    name: Generate PGO Profile (Linux)
    runs-on: ubuntu-latest
    if: ${{ inputs.platform == 'linux' || inputs.platform == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust environment
        uses: ./.github/actions/setup-rust
        with:
          components: llvm-tools-preview
          cache-key: pgo-linux

      - name: Generate PGO profile
        run: |
          chmod +x scripts/build_pgo.sh
          ./scripts/build_pgo.sh

      - name: Upload PGO profile
        uses: actions/upload-artifact@v4
        with:
          name: pgo-profile-linux
          path: target/pgo-data/merged.profdata
          retention-days: 30

  # =============================================================================
  # Generate PGO Profile for macOS
  # =============================================================================
  generate-macos:
    name: Generate PGO Profile (macOS)
    runs-on: macos-latest
    if: ${{ inputs.platform == 'macos' || inputs.platform == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: pgo-macos

      - name: Generate PGO profile
        run: |
          chmod +x scripts/build_pgo.sh
          ./scripts/build_pgo.sh

      - name: Upload PGO profile
        uses: actions/upload-artifact@v4
        with:
          name: pgo-profile-macos
          path: target/pgo-data/merged.profdata
          retention-days: 30
