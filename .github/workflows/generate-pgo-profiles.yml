name: Generate PGO Profiles

# Manual trigger only - run when you need to regenerate profiles
on:
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to generate profile for"
        required: true
        type: choice
        options:
          - windows
          - linux
          - macos
          - all

permissions:
  contents: read

jobs:
  # =============================================================================
  # Generate PGO Profile for Windows
  # =============================================================================
  generate-windows:
    name: Generate PGO Profile (Windows)
    runs-on: windows-latest
    if: ${{ inputs.platform == 'windows' || inputs.platform == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: pgo-windows

      - name: Build instrumented binary
        shell: pwsh
        run: |
          $pgoDataDir = "${{ runner.temp }}/pgo-data"
          New-Item -ItemType Directory -Force -Path $pgoDataDir | Out-Null
          $pgoDataDirUnix = $pgoDataDir -replace '\\', '/'
          $env:RUSTFLAGS = "-Cprofile-generate=$pgoDataDirUnix -Ccodegen-units=1"
          Write-Host "RUSTFLAGS: $env:RUSTFLAGS"
          cargo build --release -p cytoscnpy-cli

      - name: Run workload for profiling
        shell: pwsh
        run: |
          $pgoDataDir = "${{ runner.temp }}/pgo-data"
          $binary = "target/release/cytoscnpy-cli.exe"
          $pgoDataDirUnix = $pgoDataDir -replace '\\', '/'
          $env:LLVM_PROFILE_FILE = "$pgoDataDirUnix/cytoscnpy-%p-%m.profraw"

          Write-Host "Running workloads..."
          & $binary . --quiet 2>&1 | Out-Null
          & $binary benchmark/examples --quiet --clones --secrets 2>&1 | Out-Null
          & $binary cc . --json 2>&1 | Out-Null
          & $binary mi . --json 2>&1 | Out-Null
          & $binary hal . --json 2>&1 | Out-Null
          & $binary raw . --json 2>&1 | Out-Null

      - name: Merge profile data
        shell: pwsh
        run: |
          $pgoDataDir = "${{ runner.temp }}/pgo-data"
          $rustcSysRoot = rustc --print sysroot
          $llvmProfData = Get-ChildItem -Path "$rustcSysRoot\lib\rustlib\x86_64-pc-windows-msvc\bin\llvm-profdata.exe" -ErrorAction SilentlyContinue | Select-Object -First 1

          $profRawFiles = Get-ChildItem -Path $pgoDataDir -Filter "*.profraw" -Recurse
          Write-Host "Found $($profRawFiles.Count) profile files"

          & $llvmProfData merge -o "$pgoDataDir/merged.profdata" $profRawFiles.FullName

      - name: Upload PGO profile
        uses: actions/upload-artifact@v4
        with:
          name: pgo-profile-windows
          path: ${{ runner.temp }}/pgo-data/merged.profdata
          retention-days: 30

  # =============================================================================
  # Generate PGO Profile for Linux
  # =============================================================================
  generate-linux:
    name: Generate PGO Profile (Linux)
    runs-on: ubuntu-latest
    if: ${{ inputs.platform == 'linux' || inputs.platform == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: pgo-linux

      - name: Install mold linker
        run: sudo apt-get update && sudo apt-get install -y mold

      - name: Build instrumented binary
        run: |
          export RUSTFLAGS="-Cprofile-generate=${{ runner.temp }}/pgo-data -Ccodegen-units=1"
          echo "RUSTFLAGS: $RUSTFLAGS"
          cargo build --release -p cytoscnpy-cli

      - name: Run workload for profiling
        run: |
          mkdir -p ${{ runner.temp }}/pgo-data
          export LLVM_PROFILE_FILE="${{ runner.temp }}/pgo-data/cytoscnpy-%p-%m.profraw"

          echo "Running workloads..."
          ./target/release/cytoscnpy-cli . --quiet || true
          ./target/release/cytoscnpy-cli benchmark/examples --quiet --clones --secrets || true
          ./target/release/cytoscnpy-cli cc . --json > /dev/null || true
          ./target/release/cytoscnpy-cli mi . --json > /dev/null || true
          ./target/release/cytoscnpy-cli hal . --json > /dev/null || true
          ./target/release/cytoscnpy-cli raw . --json > /dev/null || true

      - name: Merge profile data
        run: |
          LLVM_PROFDATA=$(find $(rustc --print sysroot) -name "llvm-profdata" -type f | head -1)
          echo "Using: $LLVM_PROFDATA"

          PROFRAW_COUNT=$(find ${{ runner.temp }}/pgo-data -name "*.profraw" | wc -l)
          echo "Found $PROFRAW_COUNT profile files"

          $LLVM_PROFDATA merge -o ${{ runner.temp }}/pgo-data/merged.profdata ${{ runner.temp }}/pgo-data/*.profraw

      - name: Upload PGO profile
        uses: actions/upload-artifact@v4
        with:
          name: pgo-profile-linux
          path: ${{ runner.temp }}/pgo-data/merged.profdata
          retention-days: 30

  # =============================================================================
  # Generate PGO Profile for macOS
  # =============================================================================
  generate-macos:
    name: Generate PGO Profile (macOS)
    runs-on: macos-latest
    if: ${{ inputs.platform == 'macos' || inputs.platform == 'all' }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: pgo-macos

      - name: Build instrumented binary
        run: |
          export RUSTFLAGS="-Cprofile-generate=${{ runner.temp }}/pgo-data -Ccodegen-units=1"
          echo "RUSTFLAGS: $RUSTFLAGS"
          cargo build --release -p cytoscnpy-cli

      - name: Run workload for profiling
        run: |
          mkdir -p ${{ runner.temp }}/pgo-data
          export LLVM_PROFILE_FILE="${{ runner.temp }}/pgo-data/cytoscnpy-%p-%m.profraw"

          echo "Running workloads..."
          ./target/release/cytoscnpy-cli . --quiet || true
          ./target/release/cytoscnpy-cli benchmark/examples --quiet --clones --secrets || true
          ./target/release/cytoscnpy-cli cc . --json > /dev/null || true
          ./target/release/cytoscnpy-cli mi . --json > /dev/null || true
          ./target/release/cytoscnpy-cli hal . --json > /dev/null || true
          ./target/release/cytoscnpy-cli raw . --json > /dev/null || true

      - name: Merge profile data
        run: |
          LLVM_PROFDATA=$(find $(rustc --print sysroot) -name "llvm-profdata" -type f | head -1)
          echo "Using: $LLVM_PROFDATA"

          PROFRAW_COUNT=$(find ${{ runner.temp }}/pgo-data -name "*.profraw" | wc -l)
          echo "Found $PROFRAW_COUNT profile files"

          $LLVM_PROFDATA merge -o ${{ runner.temp }}/pgo-data/merged.profdata ${{ runner.temp }}/pgo-data/*.profraw

      - name: Upload PGO profile
        uses: actions/upload-artifact@v4
        with:
          name: pgo-profile-macos
          path: ${{ runner.temp }}/pgo-data/merged.profdata
          retention-days: 30
