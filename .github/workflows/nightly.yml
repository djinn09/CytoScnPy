name: Nightly Build

on:
  schedule:
    # Run at 2 AM UTC daily
    - cron: "0 2 * * *"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  PYO3_PYTHON: python3

jobs:
  nightly-test:
    name: Nightly Extended Test Suite
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        rust: [stable, nightly]
        python: ["3.9", "3.11", "3.13"]
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}
          cache: "pip"

      - name: Set up Rust environment
        uses: ./.github/actions/setup-rust
        with:
          rust-toolchain: ${{ matrix.rust }}
          cache-key: "nightly-${{ matrix.os }}-${{ matrix.rust }}"

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: nextest

      - name: Build all crates
        run: cargo build --all-features --verbose

      - name: Run extended Rust tests with nextest
        run: cargo nextest run --all-features --verbose --no-fail-fast
        env:
          PYO3_PYTHON: python3

      - name: Install Python dependencies
        run: pip install -e ".[dev]"

      - name: Run Python tests
        run: pytest python/tests/ -v --tb=long

      - name: Run integration tests
        run: cargo test --all-features --tests -- --include-ignored
        continue-on-error: true

  nightly-build-artifacts:
    name: Build Nightly Artifacts
    needs: nightly-test
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            name: cytoscnpy-nightly-linux-x64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            name: cytoscnpy-nightly-windows-x64.exe
          - os: macos-latest
            target: aarch64-apple-darwin
            name: cytoscnpy-nightly-macos-arm64
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust environment
        uses: ./.github/actions/setup-rust
        with:
          targets: ${{ matrix.target }}
          cache-key: "nightly-build-${{ matrix.target }}"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Build Binary
        shell: bash
        run: |
          cargo build --release --target ${{ matrix.target }} -p cytoscnpy-cli

      - name: Rename Binary
        shell: bash
        run: |
          if [ "${{ matrix.os }}" == "windows-latest" ]; then
            mv target/${{ matrix.target }}/release/cytoscnpy-cli.exe ${{ matrix.name }}
          else
            mv target/${{ matrix.target }}/release/cytoscnpy-cli ${{ matrix.name }}
          fi

      - name: Upload nightly artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ matrix.name }}
          retention-days: 7

  notify-failure:
    name: Notify on Failure
    needs: [nightly-test, nightly-build-artifacts]
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly build failed on ${new Date().toISOString().split('T')[0]}`,
              body: `The nightly build has failed. Please check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.`,
              labels: ['nightly-failure', 'automated']
            });
